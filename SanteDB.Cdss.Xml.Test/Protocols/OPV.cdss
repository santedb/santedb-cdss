// This file has been reverse-engineered from a transpiled library definition
// and does not represent the original source of the decision support logic
// Generated by SanteDB v3.0.1045.0 on 2023-12-06T12:07:59.8474455-05:00
include <org.santedb.cdss.core>
include <org.santedb.cdss.core.childcare>
define library "Oral Polio Vaccine Decision Logic"
	having id <org.santedb.cdss.vaccine.opv>
	having uuid {c2a628f3-db52-45ed-b863-0fb4b1b8e77c}
	having status active
	with metadata
		author SanteSuite Inc. and the SanteSuite Contributors
		version 3.05
		doc Contains the core decision logic for the Oral Polio Vaccination programme
	end metadata
	as
	define logic "OPV Vaccination Logic for Patient Context"
		having id <org.santedb.cdss.vaccine.opv.patient>
		having status active
		having context Patient when all(
				"Patient Is A Child",
				"Patient Is Not Deceased"
			)

		as
		define fact "Patient's OPV Birth Dose"
		as
			query(
				from hdsi($$participation[RecordTarget]$$)
				where hdsi($$source@SubstanceAdministration.doseSequence=0&
          source.participation[Product].player.typeConcept.mnemonic=VaccineType-OPV&
          source.isNegated=false$$)
				select last hdsi($$source@SubstanceAdministration$$)
				order by hdsi($$source.actTime$$)
			)

		end fact
		define fact "Patient's Last Administration of OPV Dose 1"
		as
			query(
				from hdsi($$participation[RecordTarget]$$)
				where hdsi($$
          source@SubstanceAdministration.doseSequence=1&
          source.participation[Product].player.typeConcept.mnemonic=VaccineType-OPV&
          source.isNegated=false
          $$)
				select last hdsi($$source@SubstanceAdministration$$)
				order by hdsi($$source.actTime$$)
			)

		end fact
		define fact "Patient's Last Administration of OPV Dose 2"
		as
			query(
				from hdsi($$participation[RecordTarget]$$)
				where hdsi($$
          source@SubstanceAdministration.doseSequence=2&
          source.participation[Product].player.typeConcept.mnemonic=VaccineType-OPV&
          source.isNegated=false
          $$)
				select last hdsi($$source@SubstanceAdministration$$)
				order by hdsi($$source.actTime$$)
			)

		end fact
		define fact "Patient's Last Administration of OPV Dose 3"
		as
			query(
				from hdsi($$participation[RecordTarget]$$)
				where hdsi($$
          source@SubstanceAdministration.doseSequence=3&
          source.participation[Product].player.typeConcept.mnemonic=VaccineType-OPV&
          source.isNegated=false
          $$)
				select last hdsi($$source@SubstanceAdministration$$)
				order by hdsi($$source.actTime$$)
			)

		end fact
		define fact "Patient Has an Unresolved AEFI to OPV Dose"
			with metadata
				doc Patient has an active (unresolved) AEFI to a previous dose of OPV
			end metadata
		as
			any(
				hdsi($$
            participation[RecordTarget].source.typeConcept=0744B6AD-BE39-4A08-B64D-F61CB8282267
            &participation[RecordTarget].source.relationship[HasSubject].target.typeConcept=0124fde0-7857-4815-b257-74acaa0dd92d
            &participation[RecordTarget].source.relationship[RefersTo].target.participation[Product].player.typeConcept.mnemonic=VaccineType-OPV
          $$),
				hdsi($$
            participation[RecordTarget].source.typeConcept=0124fde0-7857-4815-b257-74acaa0dd92d&
            participation[RecordTarget].source@CodedObservation.value.mnemonic=VaccineType-OPV&
            participation[RecordTarget].source.isNegated=false
          $$)
			)

		end fact
		define fact "Patient Refused Previous OPV"
			with metadata
				doc When a patient has refused a previous dose of OPV due to personal or religious reasons
			end metadata
		as
			hdsi($$
          participation[RecordTarget].source.isNegated=true&
          participation[RecordTarget].source.participation[Product].player.typeConcept.mnemonic=VaccineType-OPV&
          participation[RecordTarget].source.reasonConcept.conceptSet=3BD46185-E3C3-4A6D-A1FE-0F2C9C49360D
        $$)
		end fact
		define fact "Patient Should Receive OPV Birth Dose"
		as
			none(
				"Patient's OPV Birth Dose"
			)

		end fact
		define fact "Patient Should Receive OPV Dose 1"
		as
			none(
				"Patient's Last Administration of OPV Dose 1",
				"Patient Refused Previous OPV"
			)

		end fact
		define fact "Patient Should Receive OPV Dose 2"
		as
			all(
				"Patient's Last Administration of OPV Dose 1",
				none(
					"Patient's Last Administration of OPV Dose 2",
					"Patient Refused Previous OPV"
				)

			)

		end fact
		define fact "Patient Should Receive OPV Dose 3"
		as
			all(
				"Patient's Last Administration of OPV Dose 1",
				"Patient's Last Administration of OPV Dose 2",
				none(
					"Patient's Last Administration of OPV Dose 3",
					"Patient Refused Previous OPV"
				)

			)

		end fact
		define rule "Raise Alert if Active AEFI Reported for OPV"
		as
			when
				all(
					any(
						"Patient Should Receive OPV Birth Dose",
						"Patient Should Receive OPV Dose 1",
						"Patient Should Receive OPV Dose 2",
						"Patient Should Receive OPV Dose 3"
					)
,
					"Patient Has an Unresolved AEFI to OPV Dose"
				)

			then
				raise having priority warn 
					having type {1a4fff6c-f54f-11e8-8eb2-f2801f1b9fd1}
				$$
					
              Patient has had a previous adverse event and/or drug allergy/intolerance to OPV Dose - confirm administration with patient/guardian prior to administration
            
				$$
		end rule
		define model "OPV Dose Proposal"
			having format json
		as
			$$

            {
				      "$type": "SubstanceAdministration",
               "template":"50ac9b2d-e560-4b75-ac77-921bf0eceee8",
              "templateModel" : {
                "mnemonic" : "org.santedb.emr.sbadm.immunization",
                "oid": "1.3.5.1.4.1.52820.5.2.3.2"
              },
             
			  "typeConcept": "6e7a3521-2967-4c0a-80ec-6c5c197b2178",
              "doseQuantity" : 1.0,
              "doseUnit" : "a4fc5c93-31c2-4f87-990e-c5a4e5ea2e76",
              "route" : "0a1388b0-66fb-4063-bfe3-151dd8442838",
			  "site" : "e5b6847e-91e0-4fca-ac2e-753962008080",
			  "participation": {
				"Product": [{
                	"player" : "790be5ca-d07d-46c6-8fa0-9d4f5adf388c",
				}]
			}
		}
            
			$$
		end model
		define rule "Recommend Administration of OPV Birth Dose"
		as
			when
				"Patient Should Receive OPV Birth Dose"
			then
				propose  having model "OPV Dose Proposal"
				as
					assign hdsi($$dateOfBirth$$) to actTime
					assign hdsi($$dateOfBirth$$) to startTime
					assign csharp($$((Act)scopedObject).StartTime.Value.AddDays(14)$$) to stopTime
					assign const "0" to doseSequence
					assign const "F3BE6B88-BC8F-4263-A779-86F21EA10A47" to typeConcept overwrite
				end propose
		end rule
		define rule "Recommend Administration OPV Dose 1"
		as
			when
				"Patient Should Receive OPV Dose 1"
			then
				propose  having model "OPV Dose Proposal"
				as
					assign csharp($$context.GreaterOf(DateTime.Now, context.Target.DateOfBirth.Value.AddDays(42))$$) to actTime
					assign csharp($$context.Target.DateOfBirth.Value.AddDays(42)$$) to startTime
					assign const "1" to doseSequence
				end propose
		end rule
		define rule "Recommend Administration OPV Dose 2"
		as
			when
				"Patient Should Receive OPV Dose 2"
			then
				propose  having model "OPV Dose Proposal"
				as
					assign csharp($$((Act)context["Patient's Last Administration of OPV Dose 1"]).ActTime.Value.AddDays(28)$$) to actTime
					assign hdsi($$actTime$$ scoped-to proposal) to startTime
					assign const "2" to doseSequence
				end propose
		end rule
		define rule "Recommend Administration OPV Dose 3"
		as
			when
				"Patient Should Receive OPV Dose 3"
			then
				propose  having model "OPV Dose Proposal"
				as
					assign csharp($$((Act)context["Patient's Last Administration of OPV Dose 2"]).ActTime.Value.AddDays(28)$$) to actTime
					assign hdsi($$actTime$$ scoped-to proposal) to startTime
					assign const "3" to doseSequence
				end propose
		end rule
		define protocol "OPV Administration Protocol for Birth Delivery Encounter"
			having id <org.santedb.cdss.vaccine.opv.protocol.bdl>
			having uuid {d3a628f3-db52-45ed-b863-0fb4b1b8e77c}
			having oid "1.3.5.1.4.1.52820.5.2.3.2.5.1"
			having scope <org.santedb.emr.act.registration.birth>
		as
			when
				all(
					"Patient is Infant",
					csharp($$
              ((int)context["Patient Age In Days"]) < 5
            $$)
				)

			then
				apply "Recommend Administration of OPV Birth Dose"
		end protocol
		define protocol "OPV Administration Protocol for Children"
			having id <org.santedb.cdss.vaccine.opv.protocol>
			having uuid {c2a628f3-db52-45ed-b863-0fb4b1b8e77c}
			having oid "1.3.5.1.4.1.52820.5.2.3.2.5"
			having scope <org.santedb.ims.pediatric.routineVacc>
		as
			when
				"Patient is A Child"
			then
				apply "Recommend Administration of OPV Birth Dose"
				apply "Recommend Administration OPV Dose 1"
				apply "Recommend Administration OPV Dose 2"
				apply "Recommend Administration OPV Dose 3"
		end protocol
	end logic
end library
